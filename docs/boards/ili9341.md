# ILI9341 Display Driver
**Board targets:** `WY_BOARD_CYD`, `WY_BOARD_CYD2USB`, `WY_BOARD_ILI9341_ADAFRUIT`, `WY_BOARD_ILI9341_GENERIC`, `WY_BOARD_M5STACK_CORE`  
**Display class:** `WY_DISPLAY_ILI9341` (via `WyDisplay.h` → `Arduino_GFX_Library`)

---

## What it is
The Ilitek ILI9341 is the workhorse TFT controller of the ESP32 world — 240×320, SPI, 16-bit colour (RGB565). Fast, well-supported, tolerant of sloppy wiring compared to newer controllers. Runs at up to 40MHz SPI. Comes on almost every bare 2.4"/2.8" SPI TFT module and is the display chip on the popular CYD (Cheap Yellow Display) boards.

**ILI9341 vs ST7789:** Both are 240×320 SPI TFTs. ILI9341 has MISO (can read back display RAM), ST7789 typically doesn't. ILI9341 is 5V-tolerant on signal lines; ST7789 is strictly 3.3V. Either works fine for typical display-only use.

## Supported board targets

### `WY_BOARD_CYD` — ESP32-2432S028R "Cheap Yellow Display" 2.8"
The most common ESP32+display combo board. ILI9341 320×240 landscape, XPT2046 resistive touch on a separate HSPI bus, RGB LED, single USB.

```ini
[env:cyd]
platform  = espressif32
board     = esp32dev
framework = arduino
build_flags = -DWY_BOARD_CYD
```

### `WY_BOARD_CYD2USB` — CYD dual-USB variant
Same as CYD but with inverted display colours and slightly different touch MISO pin. Add `-DWY_DISPLAY_INVERT` is already baked into this target.

### `WY_BOARD_ILI9341_ADAFRUIT` — Adafruit 2.8" breakout
The genuine Adafruit product (product #1651 and #2478). Verified pinout mapped to typical ESP32 VSPI. XPT2046 touch on shared bus.

```ini
[env:adafruit_ili9341]
platform  = espressif32
board     = esp32dev
framework = arduino
build_flags = -DWY_BOARD_ILI9341_ADAFRUIT
```

Default wiring:
| Signal | GPIO |
|--------|------|
| SCK | 18 |
| MOSI | 23 |
| MISO | 19 |
| DC | 21 |
| CS | 5 |
| RST | 22 |
| T_CS | 4 |
| T_IRQ | 15 |

### `WY_BOARD_ILI9341_GENERIC` — AliExpress red-PCB clone
The ubiquitous 14-pin red-PCB module. All pins overridable. XPT2046 touch shares the SPI bus.

```ini
[env:generic_ili9341]
platform  = espressif32
board     = esp32dev
framework = arduino
build_flags =
    -DWY_BOARD_ILI9341_GENERIC
    -DWY_DISPLAY_ROT=1        ; landscape
    -DWY_TOUCH_CS=33
    -DWY_TOUCH_IRQ=36
```

Default wiring (VSPI-style on CYD-compatible pins):
| Signal | GPIO |
|--------|------|
| SCK / T_CLK | 14 |
| MOSI / T_DIN | 13 |
| MISO / T_DO | 12 |
| DC | 2 |
| CS | 15 |
| RST | 4 |
| BL | 21 |
| T_CS | 33 |
| T_IRQ | 36 |

### `WY_BOARD_M5STACK_CORE` — M5Stack Core
M5Stack uses an ILI9342C — a landscape-native variant of the ILI9341 with MADCTL set differently. Same `Arduino_ILI9341` driver works with rotation=0.

```ini
[env:m5stack]
platform  = espressif32
board     = m5stack-core-esp32
framework = arduino
build_flags = -DWY_BOARD_M5STACK_CORE
```

⚠️ For full M5Stack hardware (speaker, power management, IMU, buttons), use the official M5Stack library. This target is display-only.

## Usage
```cpp
#include "display/WyDisplay.h"

WyDisplay display;

void setup() {
    display.begin();
    display.gfx->fillScreen(WY_BLACK);
    display.gfx->setTextColor(WY_WHITE, WY_BLACK);
    display.gfx->setTextSize(2);
    display.gfx->setCursor(10, 10);
    display.gfx->println("ILI9341 ready");
    display.setBrightness(255);
}
```

## Rotation

| Value | Orientation | Logical size |
|-------|-------------|-------------|
| 0 | Portrait | 240×320 |
| 1 | Landscape | 320×240 ← most common for UI |
| 2 | Portrait flipped | 240×320 |
| 3 | Landscape flipped | 320×240 |

CYD uses rotation 1 (landscape) by default — the board is designed to be held horizontally.

## SPI speed
ILI9341 typically runs at 40MHz reliably. On the CYD and similar boards with short traces, 80MHz works. Slower connections (breadboard, jumper wires) — stick to 20–40MHz.

## Shared vs separate SPI bus (XPT2046 touch)

**CYD / CYD2USB:** XPT2046 is on a **separate HSPI bus** — display and touch never conflict. No special handling needed.

**Generic modules / Adafruit breakout:** XPT2046 shares the same SPI bus as the display. The library handles this via separate CS pins — only one device is active at a time. Works correctly but you cannot read touch while a DMA display transfer is in progress.

## Touch calibration
XPT2046 raw ADC values need mapping to screen pixels. The `WY_TOUCH_X_MIN/MAX` and `WY_TOUCH_Y_MIN/MAX` defines are the raw ADC values at the screen corners. Default values (200–3700) are typical but vary by module:

```cpp
// To find your actual values — print raw touch coordinates:
// XPT2046 raw: touch->readTouchRaw(&rawX, &rawY)
// Touch corners, note values, update build_flags accordingly
```

## ILI9341 vs ILI9342C (M5Stack)
The ILI9342C is physically the same controller with a different default MADCTL byte — it's wired landscape-native so rotation=0 gives 320×240 (landscape) instead of 240×320 (portrait). The `Arduino_ILI9341` driver handles this transparently — just set `WY_DISPLAY_W=320`, `WY_DISPLAY_H=240`, `WY_DISPLAY_ROT=0`.

## Wiring a bare ILI9341 module

| Module label | ESP32 GPIO | Notes |
|-------------|------------|-------|
| LED / BLK | 3.3V or GPIO | Backlight. Direct 3.3V = always full brightness |
| SCK / CLK | 14 or 18 | SPI clock |
| SDI / MOSI | 13 or 23 | Data to display |
| DC / RS | any GPIO | Data/command select — required |
| RST / RESET | any GPIO or 3.3V | Can tie to 3.3V if soft reset is OK |
| CS | any GPIO | Chip select |
| GND | GND | |
| VCC | 3.3V | Module regulates internally |
| SDO / MISO | any or NC | Only needed if reading back from display |
| T_CLK | same as SCK | Shared bus |
| T_DIN | same as MOSI | |
| T_DO | same as MISO | |
| T_CS | separate GPIO | Touch chip select |
| T_IRQ | any GPIO | Touch interrupt — LOW when touched |

## Common gotchas

**LED pin needs current limiting on some modules.** Some bare ILI9341 modules have no onboard LED resistor. If yours doesn't, add a 47–100Ω resistor in series with the LED pin. Tying directly to 3.3V without a resistor can reduce backlight lifespan.

**MISO not needed for display-only.** Leave it unconnected if you're not reading back from the display. Only needed for XPT2046 touch (T_DO).

**RST can often tie to 3.3V.** The Arduino_GFX driver performs a software reset on init if RST is `GFX_NOT_DEFINED`. On most modules this works fine — saves a GPIO. Define `WY_DISPLAY_RST=-1` to skip.

**CYD colour inversion:** The CYD2USB variant ships with colours inverted — `WyDisplay.h` calls `invertDisplay(true)` when `WY_DISPLAY_INVERT` is defined. If your CYD shows inverted colours, add `-DWY_DISPLAY_INVERT` to your build flags.
