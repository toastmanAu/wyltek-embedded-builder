# ST7789 Display Driver
**Board targets:** `WY_BOARD_TTGO_TDISPLAY`, `WY_BOARD_WAVESHARE_147_S3`, `WY_BOARD_WAVESHARE_200_S3`, `WY_BOARD_ST7789_GENERIC`  
**Display class:** `WY_DISPLAY_ST7789` (via `WyDisplay.h` → `Arduino_GFX_Library`)

---

## What it is
The ST7789 is a Sitronix TFT LCD controller, one of the most common small-display chips in the ESP32 ecosystem. SPI interface, typically 240×240 or 240×320, runs at 3.3V. Found in:

- TTGO T-Display (135×240, the classic)
- LilyGo T-Display S3 (320×170)
- Waveshare ESP32 display boards (172×320, 240×320)
- Countless bare breakout modules (Adafruit, AliExpress)
- ESP32-S3-EYE display (240×240)

## Supported board targets

### `WY_BOARD_TTGO_TDISPLAY` — TTGO T-Display 1.14"
The original $8 TTGO board that popularised the ESP32+display combo. 135×240 portrait, two side buttons.

```ini
[env:ttgo]
platform  = espressif32
board     = esp32dev
framework = arduino
build_flags = -DWY_BOARD_TTGO_TDISPLAY
```

**Battery monitoring:**
```cpp
// GPIO34 = battery voltage through ÷2 divider
float batV = analogRead(WY_BAT_ADC) * 2.0f * 3.3f / 4095.0f;
```

**Right button (GPIO35):** Input-only GPIO — no internal pullup available. Add a 10kΩ resistor externally between GPIO35 and 3.3V.

### `WY_BOARD_WAVESHARE_147_S3` — Waveshare 1.47" (172×320)
ESP32-S3 with rounded-corner display. Slimmer than the 240×320 — the unusual 172-wide resolution comes from the rounded hardware corners hiding ~34px per side.

```ini
[env:ws147]
platform  = espressif32
board     = esp32-s3-devkitc-1
framework = arduino
build_flags = -DWY_BOARD_WAVESHARE_147_S3
```

⚠️ Rounded corners — keep UI elements at least 10px from the edges or they'll be cut by the physical bezel.

### `WY_BOARD_WAVESHARE_200_S3` — Waveshare 2.0" (240×320)
Standard 240×320 portrait ST7789 on an ESP32-S3. Most common ST7789 resolution — matches the full addressable area of the controller.

```ini
[env:ws200]
platform  = espressif32
board     = esp32-s3-devkitc-1
framework = arduino
build_flags = -DWY_BOARD_WAVESHARE_200_S3
```

### `WY_BOARD_ST7789_GENERIC` — Any ST7789 breakout
For bare modules wired to any ESP32. Override pin defines in `build_flags`:

```ini
[env:myboard]
platform  = espressif32
board     = esp32dev
framework = arduino
build_flags =
    -DWY_BOARD_ST7789_GENERIC
    -DWY_DISPLAY_W=240
    -DWY_DISPLAY_H=240
    -DWY_DISPLAY_DC=2
    -DWY_DISPLAY_CS=15
    -DWY_DISPLAY_SCK=14
    -DWY_DISPLAY_MOSI=13
    -DWY_DISPLAY_RST=4
    -DWY_DISPLAY_BL=21
```

## Common ST7789 resolutions
| Size | Resolution | Notes |
|------|------------|-------|
| 1.14" | 135×240 | TTGO T-Display |
| 1.3" / 1.54" | 240×240 | Square modules — very common |
| 1.47" | 172×320 | Waveshare — rounded corners |
| 1.69" | 280×240 | Some Adafruit modules |
| 2.0" | 240×320 | Standard portrait |
| 2.4" | 240×320 | Larger format same controller |

## Usage
```cpp
#include "display/WyDisplay.h"

WyDisplay display;

void setup() {
    display.begin();
    display.gfx->fillScreen(WY_BLACK);
    display.gfx->setTextColor(WY_WHITE);
    display.gfx->setTextSize(2);
    display.gfx->setCursor(10, 10);
    display.gfx->println("Hello ST7789");
    display.setBrightness(200);  // 0–255 PWM
}
```

## SPI speed
The ST7789 runs well at 40–80MHz. Arduino_GFX defaults to 40MHz. For faster redraws:

```cpp
// In WyDisplay::begin(), after the bus construction:
// Arduino_ESP32SPI *bus = new Arduino_ESP32SPI(..., 40000000UL);
// The last argument is SPI frequency in Hz.
```

80MHz works on short traces with good decoupling. For longer wires or breadboard, stick to 40MHz.

## Rotation
| Rotation value | Orientation | Width × Height |
|----------------|-------------|----------------|
| 0 | Portrait | native W × native H |
| 1 | Landscape | native H × native W |
| 2 | Portrait flipped | native W × native H |
| 3 | Landscape flipped | native H × native W |

Set via `WY_DISPLAY_ROT` in `boards.h`, or override in build flags.

## Colour inversion
Some ST7789 modules ship with inverted colours (white appears black). If colours look wrong:
```ini
build_flags = -DWY_DISPLAY_INVERT
```
`WyDisplay.h` calls `gfx->invertDisplay(true)` when this is defined.

## Power / backlight
Most ST7789 breakouts have a backlight pin. `setBrightness(0–255)` uses LEDC PWM when `WY_DISPLAY_BL_PWM=1`. On boards where backlight is always-on (like the Waveshare S3 modules), `WY_DISPLAY_BL=-1` skips backlight init.

## Wiring a bare ST7789 module
| Module pin | ESP32 GPIO | Notes |
|------------|------------|-------|
| VCC | 3.3V | Some modules accept 5V — check |
| GND | GND | |
| SCL / SCK | any SPI CLK | 14 is common |
| SDA / MOSI | any SPI MOSI | 13 is common |
| RES / RST | any GPIO | can share with other devices if timed |
| DC / A0 | any GPIO | data/command select |
| CS / CE | any GPIO | chip select |
| BLK / BL | any GPIO (PWM-capable) | backlight |

MISO is not needed for display-only (no readback).

## Gotchas

**135×240 is not a typo.** The TTGO T-Display's ST7789 is 135 pixels wide in portrait. The controller supports 240×320 but this module only populates 135 columns. `Arduino_ST7789` takes the actual dimensions in the constructor — `WyDisplay.h` passes `WY_DISPLAY_W` and `WY_DISPLAY_H` correctly.

**240×240 square modules often need an X/Y offset.** The ST7789 controller is 240×320 internally — the 240×240 variant starts at pixel (0,80) or (0,0) depending on the module. If your image appears offset, the library handles this via the `offX`/`offY` constructor parameters. Most `Arduino_GFX` presets handle this automatically.

**Colour order.** Most ST7789 modules are RGB. A few are BGR. If red and blue are swapped, pass `true` for the colour invert parameter or swap R and B in your colour constants.
