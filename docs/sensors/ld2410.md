# HLK-LD2410 / LD2410B / LD2410C — mmWave Presence Sensor
**Driver:** `WyLD2410.h`

---

## What it is
24GHz millimetre-wave radar. Detects people — not just movement, but **stationary presence**. Someone sitting still reading a book, breathing, barely moving. PIR misses this entirely. The LD2410 catches it.

That's the entire reason this sensor exists. If you just need motion detection, use a PIR — it's cheaper and simpler. If you need to know whether a room is **occupied**, you need the LD2410.

**Variants:**
- **LD2410** — basic, UART only
- **LD2410B** — same + firmware upgradeable
- **LD2410C** — same as B + onboard Bluetooth for the HLK phone app (most common on AliExpress)

All three use the same UART protocol and this driver works with all of them.

## How it works
FMCW (Frequency Modulated Continuous Wave) radar sweeps 24GHz continuously. It detects:
- **Moving targets** — gross motion: walking, waving, sitting down
- **Stationary targets** — micro-motion: breathing, heartbeat, subtle shifts

The sensor divides its detection range into 8 **gates**, each 0.75m wide:
- Gate 0: 0–0.75m
- Gate 1: 0.75–1.5m
- Gate 2: 1.5–2.25m
- ...
- Gate 7: 5.25–6m

Each gate has independent sensitivity thresholds for moving and stationary detection. You tune these for your environment.

## Wiring
| LD2410 | ESP32 |
|--------|-------|
| VCC | **5V** (not 3.3V — sensor needs 5V) |
| GND | GND |
| TX | ESP32 RX pin |
| RX | ESP32 TX pin |
| OUT | Optional GPIO (digital presence output) |

> **OUT pin**: Goes HIGH when presence detected, LOW when clear. Useful for fast interrupt-driven detection without parsing the UART stream. Wire to a GPIO and call `setOutPin()`.

## ⚠️ 5V power — important
The sensor draws up to 200mA during radar bursts. **Do not power from ESP32 3.3V pin** — it can't source enough current. Use USB 5V, a buck converter output, or a dedicated 5V rail. GND must be common with ESP32.

## ⚠️ 256000 baud — non-standard
256000 is the fixed baud rate. It works on ESP32 hardware UART (Serial1/Serial2) without issues. Software serial will likely fail. Always use a hardware UART pin pair.

## Basic usage
```cpp
auto* pres = sensors.addUART<WyLD2410>("presence", TX_PIN, RX_PIN, 256000);
pres->setOutPin(OUT_PIN);     // optional — for fast interrupt-less reading
sensors.begin();

void loop() {
    WySensorData d = sensors.read("presence");
    if (d.ok) {
        bool present = (d.rawInt > 0);
        bool moving  = (d.rawInt & 0x01);
        bool still   = (d.rawInt & 0x02);
        Serial.printf("State: %s  Dist: %.0fcm  Energy: %.0f\n",
            present ? (moving ? "MOVING" : "STILL") : "EMPTY",
            d.raw, d.voltage);
    }
    delay(100);
}
```

## Target states (d.rawInt)
| Value | Meaning |
|-------|---------|
| 0 | No target |
| 1 | Moving target only |
| 2 | Stationary target only |
| 3 | Both moving and stationary targets |

## WySensorData fields
| Field | Content |
|-------|---------|
| `d.rawInt` | Target state (0–3, see table above) |
| `d.raw` | Detection distance in cm |
| `d.voltage` | Detection energy (0–100) — signal strength |
| `d.temperature` | Moving target energy specifically |
| `d.humidity` | Stationary target energy specifically |

## Configuration
```cpp
// Detect up to gate 5 (4.5m max) — ignore 5.25–6m
pres->setMaxGate(5);

// Hold "occupied" for 10 seconds after last detection
pres->setNoOneDuration(10);

// Gate 0 (0–0.75m) — usually suppress both to avoid self-detection
pres->setGateSensitivity(0, 0, 0);

// Gate 2 (1.5–2.25m) — desk at typical sitting distance: tune carefully
pres->setGateSensitivity(2, 40, 25);

// Gate 4 (3–3.75m) — lounge area: lower sensitivity (less important)
pres->setGateSensitivity(4, 30, 15);
```

## Tuning sensitivity — the real work

Default sensitivity is often too aggressive (false positives) or misses seated people (false negatives). Tuning takes time but pays off.

**Method:**
1. Install the **HLK LD2410 app** (available for Android/iOS — Bluetooth required, use LD2410C)
2. Watch the per-gate energy bars live while someone sits/walks in the area
3. Set moving thresholds just above the background energy level for each gate
4. Set stationary thresholds just above the background level when room is empty
5. Save to sensor, then call `dumpConfig()` to log the values to Serial

**Gate 0 (0–0.75m):** Almost always set to 0/0 — you don't want the sensor detecting itself or objects directly in front of it.

**Close gates (1–2):** Often need lower thresholds because signal is strong at close range.

**Far gates (6–7):** Often need higher thresholds because weak signals are more noise-like.

## Placement gotchas

**Air movement causes false positives.** Fans, HVAC vents, open windows with wind — all create micro-motion in the radar field. Set still-detection thresholds higher in ventilated rooms, or point the sensor away from air sources.

**Sees through walls and furniture.** The 24GHz signal passes through non-metallic materials. A person in the next room can trigger it through drywall. Narrow the detection gates to limit range.

**Metal blocks and reflects.** Metal furniture, filing cabinets, and appliances create strong reflections that can cause false positives. Keep clear of large metal surfaces or account for them in sensitivity tuning.

**Minimum range ~0.75m.** Gate 0 is the closest range. Anything inside 0.75m is essentially invisible — and may cause the sensor to detect itself. Suppress gate 0 in most installations.

**Stable mounting matters.** If the sensor moves (loose bracket, vibration from nearby motors), it detects itself moving. Mount rigidly.

## The `no-one duration` setting

After the last target disappears, the sensor holds the "occupied" state for this many seconds before reporting empty. Default is 5 seconds. For occupancy lighting: 30–60 seconds. For toilet lighting: 120+ seconds. For real-time tracking: 1–2 seconds.

## LD2410 vs PIR — when to use each

| Scenario | PIR | LD2410 |
|----------|-----|--------|
| Gross motion detection (walking past) | ✅ cheaper | ✅ |
| Person sitting still | ❌ misses them | ✅ |
| Through-wall detection | ❌ | ✅ (feature and bug) |
| 3.3V supply only | ✅ | ❌ needs 5V |
| Simple, no tuning | ✅ | ❌ needs gate tuning |
| Bathroom occupancy | ❌ | ✅ |
| Office desk occupancy | ❌ | ✅ |

## Firmware version check
```cpp
char ver[20];
pres->getFirmwareVersion(ver, sizeof(ver));
Serial.println(ver);  // e.g. "V1.6.22061416"
```

## Engineering mode (per-gate energy)
The sensor can output per-gate energy levels for all 8 gates in both moving and stationary channels. Use the HLK app to visualise this while tuning — far easier than serial logging. Once tuned, switch back to normal mode.
