# Si4703 — FM Radio Receiver
**Driver:** `WySi4703.h`

---

## What it does
A complete FM radio tuner chip (76–108 MHz) with automatic seek, RDS station name/radio text decoding, RSSI signal strength, stereo/mono switching, and volume control 0–15. Connect to an amplified speaker or headphone output.

## What you need
- Si4703 breakout board (SparkFun or similar)
- Small antenna — a 75cm wire works well
- Amplified speaker or headphone (the Si4703 outputs an audio line-level signal, not power)

## Wiring

| Si4703 Pin | ESP32 | Notes |
|-----------|-------|-------|
| SDA / SDIO | GPIO (I2C SDA) | Pull-up 4.7kΩ to 3.3V |
| SCL / SCLK | GPIO (I2C SCL) | Pull-up 4.7kΩ to 3.3V |
| RST | GPIO | **Required** — held LOW then HIGH for I2C mode |
| SEN / 2W_EN | 3.3V | Selects 2-wire (I2C) mode |
| GPIO2 | Optional GPIO | Seek/tune complete interrupt |
| LOUT | Audio out left | To amplifier/headphone |
| ROUT | Audio out right | To amplifier/headphone |
| VCC | 3.3V | |
| GND | GND | |
| ANT | Antenna wire | 75cm wire or proper antenna |

**RST pin is mandatory.** The Si4703 uses the state of SDIO at reset to select communication mode. The driver holds SDIO HIGH (via pull-up) and pulses RST LOW then HIGH to enter I2C mode. Without RST you cannot communicate with the chip.

## I2C address

Fixed at `0x10`. No address select pin.

## Code Example

```cpp
#include <WySensors.h>
#include <sensors/drivers/WySi4703.h>

WySensors sensors;
WySi4703* radio;

#define RST_PIN 4
#define SDA_PIN 21
#define SCL_PIN 22

void setup() {
    Serial.begin(115200);
    radio = sensors.addI2C<WySi4703>("radio", SDA_PIN, SCL_PIN, 0x10);
    radio->setRstPin(RST_PIN);  // must call before begin()
    sensors.begin();

    radio->tune(105.6);    // tune to 105.6 MHz
    radio->setVolume(10);  // volume 0-15
    Serial.printf("Tuned to %.1f MHz\n", radio->currentFreq());
}

void loop() {
    WySensorData d = sensors.read("radio");
    Serial.printf("%.1f MHz  RSSI=%d  %s\n",
        d.raw / 10.0f, d.rawInt,
        d.light > 0.5 ? "STEREO" : "mono");
    delay(2000);
}
```

## Seek and tune

```cpp
radio->tune(98.5);       // tune to exact frequency
float found = radio->seekUp();    // seek up to next station
float found = radio->seekDown();  // seek down
Serial.printf("Found station at %.1f MHz\n", found);
```

## Volume control

```cpp
radio->setVolume(10);   // 0 = mute, 15 = maximum
radio->volumeUp();      // +1
radio->volumeDown();    // -1
radio->mute();          // sets volume to 0
```

## Reading RDS data

```cpp
char stationName[9];
char radioText[65];

// Call repeatedly in loop — RDS arrives over multiple reads
if (radio->readRDS_PS(stationName)) {
    Serial.printf("Station: %s\n", stationName);
}
if (radio->readRDS_RT(radioText)) {
    Serial.printf("Now playing: %s\n", radioText);
}
```

## WySensorData fields

| Field | Content |
|-------|---------|
| `raw` | Current frequency × 10 (e.g. 1056 = 105.6 MHz) |
| `rawInt` | RSSI signal strength (0–75 dBµV typical) |
| `light` | Stereo indicator (1.0 = stereo, 0.0 = mono) |
| `ok` | `true` if RSSI > 5 (signal present) |

## Seek threshold

The driver configures seek threshold at RSSI = 25 by default. Stations below that signal strength are skipped. Reduce for weak signal areas:
```cpp
// Direct register access needed — not yet exposed as a method
// TODO: add setSeekThreshold() method
```

## Regional settings

The driver defaults to European/Australian settings:
- Band: 87.5–108 MHz
- Channel spacing: 100kHz
- De-emphasis: 50µs (Europe/Australia)

For the US (87.5–108 MHz, 200kHz spacing, 75µs de-emphasis), the `SYSCONFIG1` and `SYSCONFIG2` registers need adjustment. Currently requires modifying the `begin()` method.

## Gotchas

**Call `setRstPin()` before `begin()`.** If RST pin isn't set, `begin()` returns `false` immediately and prints an error. This is the most common setup mistake.

**500ms oscillator startup.** After the `TEST1` register is written to enable the crystal oscillator, the driver waits 500ms. Then another 110ms for power-up. Your `setup()` will pause here.

**Si4703 peculiar I2C protocol.** Unlike most I2C devices, the Si4703:
- Reads always return 32 bytes (all 16 registers), starting from register `0x0A`
- Writes always send 8 bytes (registers `0x02`–`0x07`) regardless of which register you want to change
- The driver maintains a shadow copy (`_regs[]`) of all registers

**RDS data arrives slowly.** RDS is broadcast at 1187.5 bps. A full 8-character station name takes several seconds to decode (it's split across multiple 2A group packets). Call `readRDS_PS()` on every `loop()` iteration and print when it returns `true`.

**Antenna matters a lot.** Without an antenna the RSSI will be very low and seek will find nothing. A 75cm (quarter-wave) wire antenna connected to the ANT pin dramatically improves reception.

**Audio output is line level.** Connect to an amplified speaker or headphone amp. The Si4703 cannot drive 8Ω speakers directly.
