# SN65HVD230 / VP230 — CAN Bus Transceiver
**Driver:** `WySN65HVD230.h`

---

## What it does
The SN65HVD230 is a transceiver — it converts between the ESP32's single-ended TWAI (CAN) signals and the differential CAN bus. It doesn't process data; it just handles the electrical interface. The ESP32 TWAI peripheral does the protocol work.

**CAN bus** (Controller Area Network) is the communication backbone of every modern vehicle, most industrial equipment, and a lot of robotics. Once you're on the bus, you can read engine data, sensor values, control modules — anything that's wired to it.

## Wiring
| Transceiver | Connection |
|-------------|------------|
| CTX (D) | ESP32 TX pin (TWAI TX) |
| CRX (R) | ESP32 RX pin (TWAI RX) |
| VCC | 3.3V |
| GND | GND |
| CANH | CAN bus high wire |
| CANL | CAN bus low wire |
| Rs (S) | GND (normal mode) |

VP230 is pin-compatible — use identically.

## Termination — critical
CAN bus requires **120Ω between CANH and CANL at each physical end of the bus**.

- Most breakout boards have a solder jumper for an onboard 120Ω resistor
- On a bench setup with two nodes: enable termination on both ends
- **Connecting to a vehicle OBD-II port: do NOT add termination** — the car already has it at both ends of the chassis wiring. Adding more will disturb the bus and may cause vehicle faults

## Baud rates
| Application | Speed |
|-------------|-------|
| OBD-II passenger cars (most) | 500 kbps |
| OBD-II older vehicles | 250 kbps |
| J1939 trucks / heavy vehicles | 250 kbps |
| Industrial / CANopen | 125–1000 kbps |
| CAN FD (this chip doesn't support) | Up to 8 Mbps |

## OBD-II — reading your car
Connect CANH/CANL to OBD-II port pins 6 (CANH) and 14 (CANL). Engine must be running or key in ACC/ON position.

```cpp
auto* can = sensors.addGPIO<WySN65HVD230>("obd2", TX_PIN, RX_PIN);
sensors.begin();

float rpm   = can->rpm();          // engine RPM
float speed = can->speedKmh();     // vehicle speed
float temp  = can->coolantTempC(); // coolant temperature
float load  = can->engineLoadPct(); // engine load %
```

### Available OBD-II PIDs (Mode 01)
| Method | Unit | Notes |
|--------|------|-------|
| `rpm()` | RPM | |
| `speedKmh()` | km/h | |
| `coolantTempC()` | °C | Range -40 to +215°C |
| `intakeTempC()` | °C | Intake air temperature |
| `throttlePct()` | % | Throttle position |
| `engineLoadPct()` | % | Calculated engine load |
| `fuelLevelPct()` | % | Fuel tank level |
| `mafGramsSec()` | g/s | Mass air flow |
| `ambientTempC()` | °C | Ambient air temp |
| `batteryVoltage()` | V | Control module supply voltage |

## ⚠️ Safety warning
**Never write arbitrary frames to a vehicle CAN bus.** Modern vehicles have safety-critical systems (ABS, airbags, stability control, electric steering, braking) on the CAN bus. Writing the wrong frame could trigger these systems unexpectedly.

OBD-II diagnostic requests (0x7DF) are **read-only by design** — the ECU only responds with data, never acts on them. Stick to Mode 01 (current data) and Mode 03 (DTC reading) for safe exploration.

If you want to write to a CAN bus, do it on a bench setup or simulator first.

## The ESP32 TWAI peripheral
ESP32 has one built-in CAN controller (TWAI = Two-Wire Automotive Interface). The SN65HVD230 transceiver connects the TWAI TX/RX pins to the differential bus.

Only one TWAI instance can run at a time — it can't be shared with other uses. On ESP32, any GPIO can be used for TWAI TX/RX (configured via the driver).

## What's coming
The current driver covers raw frames and OBD-II Mode 01. The big next steps:
- **ISO 15765-2 (ISOTP)** — multi-frame transport for DTCs, VIN, long responses
- **DTC reading and decoding** — fault codes with descriptions
- **J1939** — truck/heavy vehicle protocol
- **UDS (ISO 14229)** — advanced diagnostics (live data, parameter writes)
- **Manufacturer-specific databases** — Toyota, VAG, BMW, Ford decode tables

## Interesting projects
- **Portable OBD-II gauge**: ESP32 + SN65HVD230 + small display = $15 data logger
- **Fuel efficiency tracker**: log RPM, MAF, speed → calculate real-time L/100km
- **Trip computer**: speed, distance, fuel, temps — all from OBD-II
- **CAN bus sniffer**: passively log all frames to understand unknown vehicle buses
- **Industrial sensor network**: J1939 or CANopen on machines and robots
