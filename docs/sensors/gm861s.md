# GM861S — Barcode & QR Scanner
**Driver:** `WyGM861S.h`

---

## What it does
A UART barcode and QR code scanner module. Point it at a barcode or QR code, it scans and sends the decoded string as ASCII over serial. Supports 1D barcodes (Code128, EAN-13, UPC, QR39, etc.) and 2D barcodes (QR code, Data Matrix, PDF417, Aztec).

## Wiring

| GM861S Pin | ESP32 |
|-----------|-------|
| TX | ESP32 RX pin |
| RX | ESP32 TX pin (optional — only needed for commands) |
| GND | GND |
| VCC | 3.3V or 5V (check your module) |
| TRIG | Optional GPIO — pull LOW to trigger scan |

The minimum connection is TX→RX (scanner output) + GND + VCC. The RX→TX connection is only needed if you want to send commands (beep, sleep, trigger remotely, etc.).

## Wiring detail

```
GM861S               ESP32
  TX  ────────────── RX (e.g. GPIO 16)
  RX  ────────────── TX (e.g. GPIO 17)  [optional]
  GND ────────────── GND
  VCC ────────────── 5V or 3.3V
  TRIG ───10kΩ pull-up─ 3.3V
       ─────────────── GPIO (pull LOW to scan)  [optional]
```

## Default settings

| Setting | Value |
|---------|-------|
| Baud rate | 9600 |
| Format | 8N1 |
| Line terminator | `\r\n` (CR+LF) |
| Scan mode | Continuous (scans when object detected) |

## Code Example

```cpp
#include <WySensors.h>
#include <sensors/drivers/WyGM861S.h>

WySensors sensors;
WyGM861S* scanner;

void setup() {
    Serial.begin(115200);
    // TX=17, RX=16
    scanner = sensors.addUART<WyGM861S>("barcode", 17, 16);
    sensors.begin();
    Serial.println("Scanner ready — present a barcode");
}

void loop() {
    // Non-blocking check
    if (scanner->available()) {
        Serial.printf("Scanned: %s\n", scanner->lastBarcode());
        Serial.printf("Total scans: %d\n", scanner->scanCount());
        scanner->clear();  // clear for next scan
    }

    // Or via sensor registry:
    WySensorData d = sensors.read("barcode");
    if (d.ok) {
        Serial.println(d.error);  // barcode string stored in error field
    }
    delay(10);
}
```

## Trigger modes

| Mode | When to use |
|------|------------|
| `WY_GM861S_MODE_CONTINUOUS` | Scans constantly, outputs on new decode. Default. |
| `WY_GM861S_MODE_TRIGGER` | Scans while TRIG pin held LOW |
| `WY_GM861S_MODE_COMMAND` | Triggered via `scanner->sendTrigger()` |

```cpp
// Trigger mode with GPIO
int8_t trigPin = 4;
scanner = sensors.addUART<WyGM861S>("barcode", 17, 16, trigPin, WY_GM861S_MODE_TRIGGER);

// Trigger a scan:
scanner->triggerOn();   // pull TRIG LOW
delay(3000);            // wait for scan
scanner->triggerOff();  // release
```

## Scanner commands

```cpp
scanner->beep();    // trigger the beeper
scanner->sleep();   // put scanner in low-power mode
scanner->wake();    // wake from sleep
scanner->sendTrigger();  // trigger one scan (command mode)
scanner->sendStop();     // stop scanning
```

## WySensorData fields

| Field | Content |
|-------|---------|
| `ok` | `true` when a new barcode is available |
| `error` | Points to the decoded barcode string |
| `rawInt` | Total scan count |

Note: the `error` field is repurposed as a string buffer pointing to the barcode. This is a quirk of the WySensorData struct — it's not actually an error.

## Buffer size

The default buffer is 256 characters (`WY_GM861S_BUF_SIZE`). QR codes can hold up to 7089 characters but that's impractical on an ESP32. If you're scanning URLs or short strings, 256 is plenty. Increase with:
```
build_flags = -DWY_GM861S_BUF_SIZE=512
```

## Gotchas

**Uses Serial2 by default.** The driver hardcodes `Serial2`. If you're already using Serial2 for something else, you'll need to modify the driver or use a different serial port.

**500ms boot delay.** The scanner needs time to initialise after power-on. The driver waits 500ms in `begin()`.

**Buffer overflow drops data.** If a very long QR code arrives (>256 chars), the driver discards accumulated bytes and starts fresh. You'll miss that scan.

**The GM861S differs from the GM65.** Similar product names, different protocols. The GM861S uses the command format in the driver (9-byte frame with `0x7E 0xFF 0x06 ...`). The GM65 uses a different format. Check your module's documentation.

**TRIG pin logic.** Pull TRIG LOW to scan, HIGH to stop. The scanner scans continuously while TRIG is LOW. Don't leave it LOW indefinitely — the scanner's LED and image sensor consume significant power when active.

**Baud rate changes.** If someone has changed the scanner's baud rate via command, it won't respond at 9600. Most modules have a factory reset procedure (usually a QR code in the manual you scan to reset settings).
